var $={},Z=(Y,J,F)=>($.__chunk_31239=(B,T,g)=>{"use strict";g.d(T,{S:()=>U});var M=g(97799),w=g(52748);class D{log(d,y,p){new Date().toISOString(),this.serviceName,w._.NODE_ENV==="development"&&console.log(`[${this.serviceName}]`,y,p)}async measurePerformance(d,y){let p=performance.now();try{let b=await y(),o=performance.now()-p;return this.log("info",`${d} completed`,{duration:o}),b}catch(b){let o=performance.now()-p;throw this.log("error",`${d} failed`,{duration:o,error:b instanceof Error?b.message:"Unknown error"}),b}}async retry(d,y={}){let p,{maxAttempts:b=3,delay:o=1e3,backoff:A=!0}=y;for(let l=1;l<=b;l++)try{return await d()}catch(v){if(p=v instanceof Error?v:Error("Unknown error"),l<b){let n=A?o*2**(l-1):o;await new Promise(h=>setTimeout(h,n))}}throw p||Error("Operation failed after maximum attempts")}}class _ extends D{isConfigured(){return!!(w._.ZPAY_PID&&w._.ZPAY_KEY)}getNotifyUrl(){return`${w._.NEXTAUTH_URL.replace(/\/$/,"")}/api/payments/zpay/notify`}getReturnUrl(d){return`${w._.NEXTAUTH_URL.replace(/\/$/,"")}/checkout?orderId=${encodeURIComponent(d)}`}buildSignature(d){let y=Object.keys(d).sort().filter(p=>p!=="sign"&&p!=="sign_type"&&d[p]!=="").map(p=>`${p}=${d[p]}`).join("&");return(0,M.md5)(y+w._.ZPAY_KEY).toLowerCase()}verifySignature(d){if(!this.isConfigured())return!1;let y=d.sign;if(!y)return!1;let p=this.buildSignature(d);return y.toLowerCase()===p}async createQrPayment(d,y){if(!this.isConfigured())throw Error("\u672A\u914D\u7F6E 7Pay \u652F\u4ED8\u53C2\u6570");let p={pid:w._.ZPAY_PID,type:y.paymentMethod,out_trade_no:d.orderNo,notify_url:this.getNotifyUrl(),return_url:this.getReturnUrl(d.id),name:y.description??"Balance Top-up",money:d.amount.toFixed(2),clientip:"",device:"pc",param:d.id,sign_type:"MD5"};w._.C_ID&&(p.cid=w._.C_ID);let b=this.buildSignature(p),o=new FormData;for(let[v,n]of Object.entries(p))o.append(v,n);o.append("sign",b),this.log("info","\u5411 7Pay \u53D1\u8D77\u4E8C\u7EF4\u7801\u652F\u4ED8\u8BF7\u6C42",{orderId:d.id,orderNo:d.orderNo,paymentMethod:y.paymentMethod,amount:p.money});let A=await fetch("https://zpayz.cn/mapi.php",{method:"POST",body:o});if(!A.ok)throw this.log("error","7Pay mapi.php \u975E 200 \u54CD\u5E94",{orderId:d.id,orderNo:d.orderNo,status:A.status,statusText:A.statusText}),Error(`7Pay \u8BF7\u6C42\u5931\u8D25\uFF1A${A.status} ${A.statusText}`);let l=await A.json();if(this.log("info","7Pay \u8FD4\u56DE\u4E8C\u7EF4\u7801\u652F\u4ED8\u7ED3\u679C",{orderId:d.id,orderNo:d.orderNo,code:l.code,msg:l.msg,tradeNo:l.trade_no}),l.code!==1)throw this.log("warn","\u521B\u5EFA 7Pay \u8BA2\u5355\u5931\u8D25",l),Error(l.msg||"\u521B\u5EFA\u652F\u4ED8\u8BA2\u5355\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5");return l}async queryOrder(d){if(!this.isConfigured())throw Error("\u672A\u914D\u7F6E 7Pay \u652F\u4ED8\u53C2\u6570");let y=new URL("https://zpayz.cn/api.php");y.searchParams.set("act","order"),y.searchParams.set("pid",w._.ZPAY_PID),y.searchParams.set("key",w._.ZPAY_KEY),y.searchParams.set("out_trade_no",d);let p=await fetch(y.toString(),{method:"GET"});if(!p.ok)throw Error(`\u67E5\u8BE2 7Pay \u8BA2\u5355\u5931\u8D25\uFF1A${p.status} ${p.statusText}`);return await p.json()}constructor(...d){super(...d),this.serviceName="ZPayService"}}let U=new _},$.__chunk_2758=(B,T,g)=>{"use strict";g.d(T,{M9:()=>v,OY:()=>A,a:()=>o,tn:()=>b,yv:()=>l});var M=g(2793),w=g(65662),D=g(89538);let _="app:zpay-payment-orders";function U(n){return n.trim().toLowerCase()}function E(n){return Math.round(100*n)/100}function d(n){return E(n).toFixed(2)}async function y(){let n=await M.Yh.get(_);if(!n)return[];try{let h=typeof n=="string"?JSON.parse(n):n;return Array.isArray(h)?h.filter(f=>!!f&&typeof f.id=="string"&&typeof f.orderNo=="string"&&typeof f.email=="string"&&typeof f.amount=="number"&&typeof f.displayAmount=="string"&&typeof f.currency=="string"&&typeof f.status=="string"&&typeof f.createdAt=="string"&&typeof f.updatedAt=="string").map(f=>({...f,email:U(f.email),amount:E(f.amount),displayAmount:f.displayAmount??d(f.amount),channel:"zpay",paymentMethod:f.paymentMethod==="wxpay"?"wxpay":"alipay",status:f.status??"pending"})):[]}catch{return[]}}async function p(n){await M.Yh.set(_,JSON.stringify(n))}async function b(n){let h=U(n.email);if(!h)throw Error("\u90AE\u7BB1\u4E0D\u80FD\u4E3A\u7A7A");let f=E(Number(n.amount));if(!Number.isFinite(f)||f<=0)throw Error("\u5145\u503C\u91D1\u989D\u5FC5\u987B\u5927\u4E8E 0");let x=new Date,P=n.expiresInMinutes?new Date(x.getTime()+60*n.expiresInMinutes*1e3):void 0,N={id:crypto.randomUUID(),orderNo:`ZP${Date.now()}${Math.floor(1e6*Math.random()).toString().padStart(6,"0")}`,email:h,amount:f,displayAmount:d(f),currency:n.currency??"CNY",channel:"zpay",paymentMethod:n.paymentMethod??"alipay",status:"pending",createdAt:x.toISOString(),updatedAt:x.toISOString(),expiresAt:P?.toISOString()},O=await y();return await p([...O,N]),N}async function o(n){return n?(await y()).find(h=>h.id===n)??null:null}async function A(n){return n?(await y()).find(h=>h.orderNo===n)??null:null}async function l(n,h){let f=await y(),x=f.findIndex(z=>z.id===n);if(x<0)return null;let P=new Date().toISOString(),N={...f[x],...h,updatedAt:P},O=[...f];return O[x]=N,await p(O),N}async function v(n){let h=await y(),f=h.findIndex(C=>C.id===n.orderId);if(f<0)return null;let x=h[f];if(x.status==="paid")return x;let P=await(0,w.KJ)({email:x.email,amount:x.amount,updatedBy:n.operator??`zpay:${n.providerTradeNo??x.orderNo}`});await(0,D.Ht)({email:x.email,createdBy:n.operator??`zpay:${n.providerTradeNo??x.orderNo}`});let N=new Date().toISOString(),O={...x,status:"paid",providerTradeNo:n.providerTradeNo??x.providerTradeNo,notifyPayload:n.notifyPayload??x.notifyPayload,paidAt:N,updatedAt:N,balanceAfterPayment:P.balance},z=[...h];return z[f]=O,await p(z),O}},$.__chunk_97799=(B,T,g)=>{var M;(function(){"use strict";var w="input is invalid type",D=typeof window=="object",_=D?window:{};_.JS_MD5_NO_WINDOW&&(D=!1);var U=!D&&typeof Y=="object",E=!_.JS_MD5_NO_NODE_JS&&typeof process=="object"&&process.versions&&process.versions.node;E?_=g.g:U&&(_=Y);var d,y=!_.JS_MD5_NO_COMMON_JS&&B.exports,p=g.amdO,b=!_.JS_MD5_NO_ARRAY_BUFFER&&typeof ArrayBuffer<"u",o="0123456789abcdef".split(""),A=[128,32768,8388608,-2147483648],l=[0,8,16,24],v=["hex","array","digest","buffer","arrayBuffer","base64"],n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),h=[];if(b){var f=new ArrayBuffer(68);d=new Uint8Array(f),h=new Uint32Array(f)}var x=Array.isArray;(_.JS_MD5_NO_NODE_JS||!x)&&(x=function(t){return Object.prototype.toString.call(t)==="[object Array]"});var P=ArrayBuffer.isView;b&&(_.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW||!P)&&(P=function(t){return typeof t=="object"&&t.buffer&&t.buffer.constructor===ArrayBuffer});var N=function(t){var a=typeof t;if(a==="string")return[t,!0];if(a!=="object"||t===null)throw Error(w);if(b&&t.constructor===ArrayBuffer)return[new Uint8Array(t),!1];if(!x(t)&&!P(t))throw Error(w);return[t,!1]},O=function(t){return function(a){return new m(!0).update(a)[t]()}},z=function(t){var a,r=g(18535),e=g(25356).Buffer;return a=e.from&&!_.JS_MD5_NO_BUFFER_FROM?e.from:function(s){return new e(s)},function(s){if(typeof s=="string")return r.createHash("md5").update(s,"utf8").digest("hex");if(s==null)throw Error(w);return s.constructor===ArrayBuffer&&(s=new Uint8Array(s)),x(s)||P(s)||s.constructor===e?r.createHash("md5").update(a(s)).digest("hex"):t(s)}},C=function(t){return function(a,r){return new k(a,!0).update(r)[t]()}};function m(t){if(t)h[0]=h[16]=h[1]=h[2]=h[3]=h[4]=h[5]=h[6]=h[7]=h[8]=h[9]=h[10]=h[11]=h[12]=h[13]=h[14]=h[15]=0,this.blocks=h,this.buffer8=d;else if(b){var a=new ArrayBuffer(68);this.buffer8=new Uint8Array(a),this.blocks=new Uint32Array(a)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}function k(t,a){var r,e=N(t);if(t=e[0],e[1]){var s,u=[],i=t.length,c=0;for(r=0;r<i;++r)(s=t.charCodeAt(r))<128?u[c++]=s:(s<2048?u[c++]=192|s>>>6:(s<55296||s>=57344?u[c++]=224|s>>>12:(s=65536+((1023&s)<<10|1023&t.charCodeAt(++r)),u[c++]=240|s>>>18,u[c++]=128|s>>>12&63),u[c++]=128|s>>>6&63),u[c++]=128|63&s);t=u}t.length>64&&(t=new m(!0).update(t).array());var S=[],R=[];for(r=0;r<64;++r){var j=t[r]||0;S[r]=92^j,R[r]=54^j}m.call(this,a),this.update(R),this.oKeyPad=S,this.inner=!0,this.sharedMemory=a}m.prototype.update=function(t){if(this.finalized)throw Error("finalize already called");var a=N(t);t=a[0];for(var r,e,s=a[1],u=0,i=t.length,c=this.blocks,S=this.buffer8;u<i;){if(this.hashed&&(this.hashed=!1,c[0]=c[16],c[16]=c[1]=c[2]=c[3]=c[4]=c[5]=c[6]=c[7]=c[8]=c[9]=c[10]=c[11]=c[12]=c[13]=c[14]=c[15]=0),s)if(b)for(e=this.start;u<i&&e<64;++u)(r=t.charCodeAt(u))<128?S[e++]=r:(r<2048?S[e++]=192|r>>>6:(r<55296||r>=57344?S[e++]=224|r>>>12:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++u)),S[e++]=240|r>>>18,S[e++]=128|r>>>12&63),S[e++]=128|r>>>6&63),S[e++]=128|63&r);else for(e=this.start;u<i&&e<64;++u)(r=t.charCodeAt(u))<128?c[e>>>2]|=r<<l[3&e++]:(r<2048?c[e>>>2]|=(192|r>>>6)<<l[3&e++]:(r<55296||r>=57344?c[e>>>2]|=(224|r>>>12)<<l[3&e++]:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++u)),c[e>>>2]|=(240|r>>>18)<<l[3&e++],c[e>>>2]|=(128|r>>>12&63)<<l[3&e++]),c[e>>>2]|=(128|r>>>6&63)<<l[3&e++]),c[e>>>2]|=(128|63&r)<<l[3&e++]);else if(b)for(e=this.start;u<i&&e<64;++u)S[e++]=t[u];else for(e=this.start;u<i&&e<64;++u)c[e>>>2]|=t[u]<<l[3&e++];this.lastByteIndex=e,this.bytes+=e-this.start,e>=64?(this.start=e-64,this.hash(),this.hashed=!0):this.start=e}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this},m.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,a=this.lastByteIndex;t[a>>>2]|=A[3&a],a>=56&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},m.prototype.hash=function(){var t,a,r,e,s,u,i=this.blocks;this.first?(r=((r=(-271733879^(e=((e=(-1732584194^2004318071&(t=((t=i[0]-680876937)<<7|t>>>25)-271733879|0))+i[1]-117830708)<<12|e>>>20)+t|0)&(-271733879^t))+i[2]-1126478375)<<17|r>>>15)+e|0,a=((a=(t^r&(e^t))+i[3]-1316259209)<<22|a>>>10)+r|0):(t=this.h0,a=this.h1,r=this.h2,t+=((e=this.h3)^a&(r^e))+i[0]-680876936,e+=(r^(t=(t<<7|t>>>25)+a|0)&(a^r))+i[1]-389564586,r+=(a^(e=(e<<12|e>>>20)+t|0)&(t^a))+i[2]+606105819,a+=(t^(r=(r<<17|r>>>15)+e|0)&(e^t))+i[3]-1044525330,a=(a<<22|a>>>10)+r|0),t+=(e^a&(r^e))+i[4]-176418897,e+=(r^(t=(t<<7|t>>>25)+a|0)&(a^r))+i[5]+1200080426,r+=(a^(e=(e<<12|e>>>20)+t|0)&(t^a))+i[6]-1473231341,a+=(t^(r=(r<<17|r>>>15)+e|0)&(e^t))+i[7]-45705983,t+=(e^(a=(a<<22|a>>>10)+r|0)&(r^e))+i[8]+1770035416,e+=(r^(t=(t<<7|t>>>25)+a|0)&(a^r))+i[9]-1958414417,r+=(a^(e=(e<<12|e>>>20)+t|0)&(t^a))+i[10]-42063,a+=(t^(r=(r<<17|r>>>15)+e|0)&(e^t))+i[11]-1990404162,t+=(e^(a=(a<<22|a>>>10)+r|0)&(r^e))+i[12]+1804603682,e+=(r^(t=(t<<7|t>>>25)+a|0)&(a^r))+i[13]-40341101,r+=(a^(e=(e<<12|e>>>20)+t|0)&(t^a))+i[14]-1502002290,a+=(t^(r=(r<<17|r>>>15)+e|0)&(e^t))+i[15]+1236535329,a=(a<<22|a>>>10)+r|0,t+=(r^e&(a^r))+i[1]-165796510,t=(t<<5|t>>>27)+a|0,e+=(a^r&(t^a))+i[6]-1069501632,e=(e<<9|e>>>23)+t|0,r+=(t^a&(e^t))+i[11]+643717713,r=(r<<14|r>>>18)+e|0,a+=(e^t&(r^e))+i[0]-373897302,a=(a<<20|a>>>12)+r|0,t+=(r^e&(a^r))+i[5]-701558691,t=(t<<5|t>>>27)+a|0,e+=(a^r&(t^a))+i[10]+38016083,e=(e<<9|e>>>23)+t|0,r+=(t^a&(e^t))+i[15]-660478335,r=(r<<14|r>>>18)+e|0,a+=(e^t&(r^e))+i[4]-405537848,a=(a<<20|a>>>12)+r|0,t+=(r^e&(a^r))+i[9]+568446438,t=(t<<5|t>>>27)+a|0,e+=(a^r&(t^a))+i[14]-1019803690,e=(e<<9|e>>>23)+t|0,r+=(t^a&(e^t))+i[3]-187363961,r=(r<<14|r>>>18)+e|0,a+=(e^t&(r^e))+i[8]+1163531501,a=(a<<20|a>>>12)+r|0,t+=(r^e&(a^r))+i[13]-1444681467,t=(t<<5|t>>>27)+a|0,e+=(a^r&(t^a))+i[2]-51403784,e=(e<<9|e>>>23)+t|0,r+=(t^a&(e^t))+i[7]+1735328473,r=(r<<14|r>>>18)+e|0,a+=(e^t&(r^e))+i[12]-1926607734,t+=((s=(a=(a<<20|a>>>12)+r|0)^r)^e)+i[5]-378558,e+=(s^(t=(t<<4|t>>>28)+a|0))+i[8]-2022574463,r+=((u=(e=(e<<11|e>>>21)+t|0)^t)^a)+i[11]+1839030562,a+=(u^(r=(r<<16|r>>>16)+e|0))+i[14]-35309556,t+=((s=(a=(a<<23|a>>>9)+r|0)^r)^e)+i[1]-1530992060,e+=(s^(t=(t<<4|t>>>28)+a|0))+i[4]+1272893353,r+=((u=(e=(e<<11|e>>>21)+t|0)^t)^a)+i[7]-155497632,a+=(u^(r=(r<<16|r>>>16)+e|0))+i[10]-1094730640,t+=((s=(a=(a<<23|a>>>9)+r|0)^r)^e)+i[13]+681279174,e+=(s^(t=(t<<4|t>>>28)+a|0))+i[0]-358537222,r+=((u=(e=(e<<11|e>>>21)+t|0)^t)^a)+i[3]-722521979,a+=(u^(r=(r<<16|r>>>16)+e|0))+i[6]+76029189,t+=((s=(a=(a<<23|a>>>9)+r|0)^r)^e)+i[9]-640364487,e+=(s^(t=(t<<4|t>>>28)+a|0))+i[12]-421815835,r+=((u=(e=(e<<11|e>>>21)+t|0)^t)^a)+i[15]+530742520,a+=(u^(r=(r<<16|r>>>16)+e|0))+i[2]-995338651,a=(a<<23|a>>>9)+r|0,t+=(r^(a|~e))+i[0]-198630844,t=(t<<6|t>>>26)+a|0,e+=(a^(t|~r))+i[7]+1126891415,e=(e<<10|e>>>22)+t|0,r+=(t^(e|~a))+i[14]-1416354905,r=(r<<15|r>>>17)+e|0,a+=(e^(r|~t))+i[5]-57434055,a=(a<<21|a>>>11)+r|0,t+=(r^(a|~e))+i[12]+1700485571,t=(t<<6|t>>>26)+a|0,e+=(a^(t|~r))+i[3]-1894986606,e=(e<<10|e>>>22)+t|0,r+=(t^(e|~a))+i[10]-1051523,r=(r<<15|r>>>17)+e|0,a+=(e^(r|~t))+i[1]-2054922799,a=(a<<21|a>>>11)+r|0,t+=(r^(a|~e))+i[8]+1873313359,t=(t<<6|t>>>26)+a|0,e+=(a^(t|~r))+i[15]-30611744,e=(e<<10|e>>>22)+t|0,r+=(t^(e|~a))+i[6]-1560198380,r=(r<<15|r>>>17)+e|0,a+=(e^(r|~t))+i[13]+1309151649,a=(a<<21|a>>>11)+r|0,t+=(r^(a|~e))+i[4]-145523070,t=(t<<6|t>>>26)+a|0,e+=(a^(t|~r))+i[11]-1120210379,e=(e<<10|e>>>22)+t|0,r+=(t^(e|~a))+i[2]+718787259,r=(r<<15|r>>>17)+e|0,a+=(e^(r|~t))+i[9]-343485551,a=(a<<21|a>>>11)+r|0,this.first?(this.h0=t+1732584193|0,this.h1=a-271733879|0,this.h2=r-1732584194|0,this.h3=e+271733878|0,this.first=!1):(this.h0=this.h0+t|0,this.h1=this.h1+a|0,this.h2=this.h2+r|0,this.h3=this.h3+e|0)},m.prototype.hex=function(){this.finalize();var t=this.h0,a=this.h1,r=this.h2,e=this.h3;return o[t>>>4&15]+o[15&t]+o[t>>>12&15]+o[t>>>8&15]+o[t>>>20&15]+o[t>>>16&15]+o[t>>>28&15]+o[t>>>24&15]+o[a>>>4&15]+o[15&a]+o[a>>>12&15]+o[a>>>8&15]+o[a>>>20&15]+o[a>>>16&15]+o[a>>>28&15]+o[a>>>24&15]+o[r>>>4&15]+o[15&r]+o[r>>>12&15]+o[r>>>8&15]+o[r>>>20&15]+o[r>>>16&15]+o[r>>>28&15]+o[r>>>24&15]+o[e>>>4&15]+o[15&e]+o[e>>>12&15]+o[e>>>8&15]+o[e>>>20&15]+o[e>>>16&15]+o[e>>>28&15]+o[e>>>24&15]},m.prototype.toString=m.prototype.hex,m.prototype.digest=function(){this.finalize();var t=this.h0,a=this.h1,r=this.h2,e=this.h3;return[255&t,t>>>8&255,t>>>16&255,t>>>24&255,255&a,a>>>8&255,a>>>16&255,a>>>24&255,255&r,r>>>8&255,r>>>16&255,r>>>24&255,255&e,e>>>8&255,e>>>16&255,e>>>24&255]},m.prototype.array=m.prototype.digest,m.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),a=new Uint32Array(t);return a[0]=this.h0,a[1]=this.h1,a[2]=this.h2,a[3]=this.h3,t},m.prototype.buffer=m.prototype.arrayBuffer,m.prototype.base64=function(){for(var t,a,r,e="",s=this.array(),u=0;u<15;)t=s[u++],a=s[u++],r=s[u++],e+=n[t>>>2]+n[(t<<4|a>>>4)&63]+n[(a<<2|r>>>6)&63]+n[63&r];return e+(n[(t=s[u])>>>2]+n[t<<4&63]+"==")},k.prototype=new m,k.prototype.finalize=function(){if(m.prototype.finalize.call(this),this.inner){this.inner=!1;var t=this.array();m.call(this,this.sharedMemory),this.update(this.oKeyPad),this.update(t),m.prototype.finalize.call(this)}};var I=function(){var t=O("hex");E&&(t=z(t)),t.create=function(){return new m},t.update=function(e){return t.create().update(e)};for(var a=0;a<v.length;++a){var r=v[a];t[r]=O(r)}return t}();I.md5=I,I.md5.hmac=function(){var t=C("hex");t.create=function(e){return new k(e)},t.update=function(e,s){return t.create(e).update(s)};for(var a=0;a<v.length;++a){var r=v[a];t[r]=C(r)}return t}(),y?B.exports=I:(_.md5=I,p&&((M=function(){return I}.call(I,g,I,B))===void 0||(B.exports=M)))})()},$);export{Z as __getNamedExports};
