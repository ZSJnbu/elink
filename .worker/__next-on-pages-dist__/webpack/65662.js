var g={},D=(O,_,x)=>(g.__chunk_65662=(I,h,y)=>{"use strict";y.d(h,{KJ:()=>E,Ms:()=>T,gu:()=>k,qw:()=>N,r1:()=>S});var p=y(2793);let m="app:user-balances",w="app:user-usage";function d(e){return e.trim().toLowerCase()}function l(e){return Math.round(100*e)/100}async function f(){let e=await p.Yh.get(m);if(!e)return[];try{let a=typeof e=="string"?JSON.parse(e):e;return Array.isArray(a)?a.filter(t=>!!t&&typeof t.email=="string"&&typeof t.balance=="number"&&typeof t.updatedAt=="string"&&typeof t.updatedBy=="string").map(t=>({email:d(t.email),balance:l(t.balance),updatedAt:t.updatedAt,updatedBy:t.updatedBy})):[]}catch{return[]}}async function c(e){await p.Yh.set(m,JSON.stringify(e))}async function A(){let e=await p.Yh.get(w);if(!e)return[];try{let a=typeof e=="string"?JSON.parse(e):e;return Array.isArray(a)?a.filter(t=>!!t&&typeof t.email=="string"&&typeof t.totalTokens=="number"&&typeof t.totalSpent=="number"&&typeof t.lastUsedAt=="string").map(t=>({email:d(t.email),totalTokens:t.totalTokens,totalSpent:l(t.totalSpent),lastUsedAt:t.lastUsedAt})):[]}catch{return[]}}async function b(e){await p.Yh.set(w,JSON.stringify(e))}async function S(e){let a=d(e);return(await f()).find(n=>n.email===a)?.balance??0}async function N(){return(await f()).sort((e,a)=>new Date(a.updatedAt).getTime()-new Date(e.updatedAt).getTime())}async function E(e){let a=d(e.email),t=l(Number(e.amount));if(!a)throw Error("\u90AE\u7BB1\u4E0D\u80FD\u4E3A\u7A7A");if(!Number.isFinite(t)||t<=0)throw Error("\u5145\u503C\u91D1\u989D\u5FC5\u987B\u5927\u4E8E 0");let n=await f(),r=n.findIndex(o=>o.email===a),i=new Date().toISOString(),u=r>=0?{...n[r],balance:l(n[r].balance+t),updatedAt:i,updatedBy:e.updatedBy}:{email:a,balance:l(t),updatedAt:i,updatedBy:e.updatedBy};if(r>=0){let o=[...n];o[r]=u,await c(o)}else await c([...n,u]);return u}async function T(e){let a=d(e.email),t=l(Number(e.amount));if(!a)throw Error("\u90AE\u7BB1\u4E0D\u80FD\u4E3A\u7A7A");if(!Number.isFinite(t)||t<=0)throw Error("\u6263\u8D39\u91D1\u989D\u5FC5\u987B\u5927\u4E8E 0");let n=await f(),r=n.findIndex(B=>B.email===a);if(r<0)throw Error("\u4F59\u989D\u4E0D\u8DB3\uFF0C\u8BF7\u5148\u5145\u503C");let i=n[r];if(i.balance<t)throw Error("\u4F59\u989D\u4E0D\u8DB3\uFF0C\u8BF7\u5148\u5145\u503C");let u=new Date().toISOString(),o={...i,balance:l(i.balance-t),updatedAt:u,updatedBy:e.updatedBy},s=[...n];return s[r]=o,await c(s),o}async function k(e){let a=d(e.email),t=Number(e.tokens),n=l(Number(e.cost));if(!a)throw Error("\u90AE\u7BB1\u4E0D\u80FD\u4E3A\u7A7A");if(!Number.isFinite(t)||t<0)throw Error("Token \u6570\u91CF\u65E0\u6548");let r=await A(),i=r.findIndex(s=>s.email===a),u=new Date().toISOString(),o=i>=0?{...r[i],totalTokens:r[i].totalTokens+t,totalSpent:l(r[i].totalSpent+n),lastUsedAt:u}:{email:a,totalTokens:t,totalSpent:l(n),lastUsedAt:u};if(i>=0){let s=[...r];s[i]=o,await b(s)}else await b([...r,o]);return o}},g);export{D as __getNamedExports};
