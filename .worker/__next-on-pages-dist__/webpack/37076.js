var v={},M=(x,P,T)=>(v.__chunk_37076=(D,E,n)=>{n.d(E,{BU:()=>C,L9:()=>S,SQ:()=>A,ZU:()=>w});var y=n(32042);n(7218);var _=n(51817),p=n(65662),I=n(2421),o=n(2758),f=n(31239);async function w(l,m,i){let e=await(0,_.j2)(),a=e?.user?.email?e.user.email:(m??"").trim().toLowerCase();if(!a)return{success:!1,message:"\u8BF7\u586B\u5199\u6709\u6548\u7684\u90AE\u7BB1\u5730\u5740"};let s=Number.parseFloat(l);if(!Number.isFinite(s)||s<=0)return{success:!1,message:"\u8BF7\u8F93\u5165\u5927\u4E8E 0 \u7684\u5145\u503C\u91D1\u989D"};if(!f.S.isConfigured())return{success:!1,message:"\u652F\u4ED8\u6E20\u9053\u6682\u672A\u914D\u7F6E\uFF0C\u8BF7\u8054\u7CFB\u7BA1\u7406\u5458\u540E\u91CD\u8BD5\u3002"};let c=i==="wxpay"?"wxpay":"alipay",r=await(0,o.tn)({email:a,amount:s,currency:"CNY",paymentMethod:c,expiresInMinutes:30});try{let t=await f.S.createQrPayment(r,{paymentMethod:c,description:`Balance top-up ${r.displayAmount}`}),u=await(0,o.yv)(r.id,{providerTradeNo:typeof t.trade_no=="string"?t.trade_no:void 0,qrCode:typeof t.qrcode=="string"?t.qrcode:void 0,qrImage:typeof t.img=="string"?t.img:void 0,payUrl:typeof t.payurl=="string"?t.payurl:typeof t.qrcode=="string"?t.qrcode:void 0,mapiPayload:t,paymentMethod:c});return{success:!0,email:u?.email??r.email,orderId:r.id,orderNo:r.orderNo,displayAmount:r.displayAmount,qrCode:u?.qrCode??r.qrCode,qrImage:u?.qrImage??r.qrImage,payUrl:u?.payUrl??r.payUrl,paymentMethod:c,expiresAt:r.expiresAt}}catch(t){return await(0,o.yv)(r.id,{status:"failed"}),{success:!1,message:t instanceof Error?t.message:"\u521B\u5EFA\u652F\u4ED8\u8BA2\u5355\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5"}}}async function S(l,m){let i=l.trim().toLowerCase();if(!i)throw Error("\u90AE\u7BB1\u4E0D\u80FD\u4E3A\u7A7A");let e=Number(m);if(!Number.isFinite(e)||e<0)throw Error("Token \u6570\u91CF\u65E0\u6548");let{pricePerThousandTokens:a}=await(0,I.q)(),s=Math.round(a*e/1e3*100)/100;if(s<=0)return{email:i,cost:0,balance:await(0,p.r1)(i)};let c=await(0,p.Ms)({email:i,amount:s,updatedBy:i});return await(0,p.gu)({email:i,tokens:e,cost:s}),{email:i,cost:s,balance:c.balance}}async function A(l){return l?(0,p.r1)(l):0}async function C(l){let m=l.trim();if(!m)return{success:!1,message:"\u8BA2\u5355\u53F7\u65E0\u6548"};let i=await(0,_.j2)(),e=await(0,o.a)(m);if(!e)return{success:!1,message:"\u672A\u627E\u5230\u5BF9\u5E94\u7684\u652F\u4ED8\u8BA2\u5355"};if(i?.user?.email&&i.user.email!==e.email)return{success:!1,message:"\u65E0\u6743\u67E5\u770B\u8BE5\u8BA2\u5355\u7684\u72B6\u6001"};let a=e,s=new Date;if(e.status==="pending"){if(e.expiresAt&&new Date(e.expiresAt)<s)a=await(0,o.yv)(e.id,{status:"expired"})??e;else if(f.S.isConfigured()){let r=e.lastSyncedAt?new Date(e.lastSyncedAt):null;if((r?s.getTime()-r.getTime():1/0)>1e4)try{let t=await f.S.queryOrder(e.orderNo);console.log("[ZPAY] query result",{orderId:e.id,orderNo:e.orderNo,raw:t}),await(0,o.yv)(e.id,{lastSyncedAt:s.toISOString(),syncAttempts:(e.syncAttempts??0)+1,mapiPayload:t});let u=t?.code,N=u!=null?String(u).trim():"",q=N.toUpperCase(),U=N==="1"||q==="1"||q==="SUCCESS",g=t?.status??t?.trade_status??t?.trade_state??t?.state??t?.order_status??t?.pay_status,b=typeof g=="string"?g.trim():g!=null?String(g).trim():"",d=b.toUpperCase(),h=b==="1"||d==="1"||d==="PAID"||d==="SUCCESS"||d==="SUCCEED"||d==="TRADE_SUCCESS"||d==="FINISHED"||d==="COMPLETED"||d==="OK"||d==="PAY_SUCCESS"||b.includes("\u652F\u4ED8");a=U&&h?await(0,o.M9)({orderId:e.id,providerTradeNo:typeof t.trade_no=="string"?t.trade_no:void 0,notifyPayload:t,operator:"zpay:sync"})??e:await(0,o.a)(e.id)??e}catch(t){await(0,o.yv)(e.id,{lastSyncedAt:s.toISOString(),syncAttempts:(e.syncAttempts??0)+1}),console.error("\u540C\u6B65 7Pay \u8BA2\u5355\u5931\u8D25",t),a=await(0,o.a)(e.id)??e}}}let c=a.status==="paid"?await(0,p.r1)(a.email):void 0;return{success:!0,status:a.status,balance:c,email:a.email,orderId:a.id,orderNo:a.orderNo,displayAmount:a.displayAmount}}(0,n(78446).D)([w,S,A,C]),(0,y.A)(w,"70fe885fa7669e3795aee230f7e998238a89ff4df0",null),(0,y.A)(S,"60064f58dce69fd87795d97a80d927e732cbfc8c08",null),(0,y.A)(A,"406ac46e86d11021b42b2b6f7a751c1aec1df9f321",null),(0,y.A)(C,"4082fbaa96fc13fd557ac521c7d38744bc62c7d0f3",null)},v);export{M as __getNamedExports};
